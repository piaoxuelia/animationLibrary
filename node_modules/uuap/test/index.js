var querystring = require("querystring");
var url = require("url");

//加载uuap
var uuap = require("uuap");

require("http").createServer(function (req, res) {
	if (req.url == '/favicon.ico') {
		res.end();
		return;
	};
	res.setHeader("Content-Type", "text/html;charset=utf-8");
	
	var urlInfo = url.parse("//" + req.headers.host + req.url, true, true);
	var query = urlInfo.query;
	if (query.force) {
		//通过getUserInfo接口获取用户信息, 如果没有登录则强制跳转到登录页面
		//返回一个promise
		uuap.getUserInfo(req, res).then(function(userInfo){
			res.write("<h1>登录信息为：</h1>", "utf-8");
			res.write(JSON.stringify(userInfo, undefined, 4), "utf-8");
			res.write('<br><br><a href="?logout=1">退出</a>', "utf-8");
			res.end();
		})
	}else if(query.logout){
		//退出
		uuap.logout(req, res);
		res.statusCode = 302;
		res.setHeader("Location", "/");
		res.end();
	}else{
		//通过getUserInfo接口获取用户信息，如果没有登录useInfo为空
		//返回一个promise
		uuap.getUserInfo(req, res, false).then(function(userInfo){
			if (Object.keys(userInfo).length == 0) {
				res.write("尚未登录");
				res.write('<br><br><a href="?force=1">点击登录</a>')
			}else{
				res.write("<h1>登录信息为：</h1>");
				res.write(JSON.stringify(userInfo, undefined, 4), "utf-8");
				res.write('<br><br><a href="?logout=1">退出</a>', "utf-8");
			}
			res.end();
		})
	}
}).listen(9527);